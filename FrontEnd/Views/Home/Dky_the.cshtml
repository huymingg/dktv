@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section styles {
    <link rel="stylesheet" href="./css/Dky_the.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
}

        <div class="main">
            <div class="left-main">
                <div class="left-main-header">Thông tin thẻ</div>
                <div class="left-main-content">
                    <div class="title-content-left"><h5>Thông tin cá nhân</h5></div>
                    <div class="main-content-left">
                <form class="register-card" novalidate>
                    <div class="form-row">
                                <label for="typeCard">Loại thẻ<span style="color: red;">(*)</span></label>
                                <span class="icon-span-select"><i class="fa-solid fa-id-card"></i></span>
                                <select name="typeCard" id="loaiThe">
                                        
                                </select>
                    </div>
                    <div class="form-row">
                                <label for="typeCard">Loại bạn đọc<span style="color: red;">(*)</span></label>
                                <span class="icon-span-select"><i class="fa-solid fa-user"></i></span>
                                <select name="typeCard" id="banDoc">
                                    
                                </select>
                     </div>
                    <div class="form-row">
                                <label for="name">Họ và tên<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-user"></i></span>
                                <input type="text" id="name" placeholder="Nhập Họ Và Tên Của Bạn" required>
                            </div>
                    <div class="form-row">
                                <label for="name">Giới tính<span style="color: red;">(*)</span></label>
                                <span class="radio-span"><input type="radio" name="gender" value="Nam" checked><div>Nam</div></span>
                                <span class="radio-span"><input type="radio" name="gender" value="Nữ"><div>Nữ</div></span>
                            </div>
                    <div class="form-row">
                                <label for="name">Ngày sinh<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-calendar-days"></i></span>
                                <input type="text" id="calendar" name="calendar" placeholder="Ngày/Tháng/Năm" required>
                            </div>
                    <div class="form-row" id="cmnd-row">
                                <label for="name">CMND/CCCD<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-address-card"></i></span>
                                <input type="text" id="CMND" placeholder="CMND/CCCD" required>
                            </div>
                    <div class="form-row">
                                <label for="name">Địa chỉ<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-location-dot"></i></span>
                                <input type="text" id="address" placeholder="Địa chỉ" required>
                            </div>
                    <div class="form-row">
                                <label for="name">Email<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-envelope"></i></span>
                                <input type="email" id="email" placeholder="Email" required>
                            </div>
                    <div class="form-row">
                                <label for="name">Điện thoại<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-mobile-screen-button"></i></span>
                                <input type="number" id="phone" placeholder="Điện thoại" required>
                            </div>
                    <div class="form-row">
                                <label for="typeCard">Nghề nghiệp<span style="color: red;">(*)</span></label>
                                <span class="icon-span-select"><i class="fa-solid fa-briefcase"></i></span>
                                <select name="typeCard" id="ngheNghiep">
                                    
                                </select>
                            </div>
                    <div class="form-row" id="working-row">
                                <label for="name">Nơi làm việc<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-house"></i></span>
                                <input type="text" id="working" placeholder="Nơi làm việc" required>
                            </div>
                    <div class="form-row">
                                <label for="typeCard">Quốc tịch<span style="color: red;">(*)</span></label>
                                <span class="icon-span-select"><i class="fa-solid fa-earth-asia"></i></span>
                                <select name="typeCard" id="quocTich">
                                    <option value="Vietnam">Việt Nam</option>
                                    <option value="Afghanistan">Afghanistan</option>
                                    <option value="Albania">Albania</option>
                                    <option value="Algeria">Algeria</option>
                                    <option value="Andorra">Andorra</option>
                                    <option value="Angola">Angola</option>
                                    <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                                    <option value="Argentina">Argentina</option>
                                    <option value="Armenia">Armenia</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Austria">Austria</option>
                                    <option value="Azerbaijan">Azerbaijan</option>
                                    <option value="Bahamas">Bahamas</option>
                                    <option value="Bahrain">Bahrain</option>
                                    <option value="Bangladesh">Bangladesh</option>
                                    <option value="Barbados">Barbados</option>
                                    <option value="Belarus">Belarus</option>
                                    <option value="Belgium">Belgium</option>
                                    <option value="Belize">Belize</option>
                                    <option value="Benin">Benin</option>
                                    <option value="Bhutan">Bhutan</option>
                                    <option value="Bolivia">Bolivia</option>
                                    <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                                    <option value="Botswana">Botswana</option>
                                    <option value="Brazil">Brazil</option>
                                    <option value="Brunei">Brunei</option>
                                    <option value="Bulgaria">Bulgaria</option>
                                    <option value="Burkina Faso">Burkina Faso</option>
                                    <option value="Burundi">Burundi</option>
                                    <option value="Cabo Verde">Cabo Verde</option>
                                    <option value="Cambodia">Cambodia</option>
                                    <option value="Cameroon">Cameroon</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Central African Republic">Central African Republic</option>
                                    <option value="Chad">Chad</option>
                                    <option value="Chile">Chile</option>
                                    <option value="China">China</option>
                                    <option value="Colombia">Colombia</option>
                                    <option value="Comoros">Comoros</option>
                                    <option value="Congo (Congo-Brazzaville)">Congo (Congo-Brazzaville)</option>
                                    <option value="Costa Rica">Costa Rica</option>
                                    <option value="Croatia">Croatia</option>
                                    <option value="Cuba">Cuba</option>
                                    <option value="Cyprus">Cyprus</option>
                                    <option value="Czech Republic">Czech Republic</option>
                                    <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
                                    <option value="Denmark">Denmark</option>
                                    <option value="Djibouti">Djibouti</option>
                                    <option value="Dominica">Dominica</option>
                                    <option value="Dominican Republic">Dominican Republic</option>
                                    <option value="Ecuador">Ecuador</option>
                                    <option value="Egypt">Egypt</option>
                                    <option value="El Salvador">El Salvador</option>
                                    <option value="Equatorial Guinea">Equatorial Guinea</option>
                                    <option value="Eritrea">Eritrea</option>
                                    <option value="Estonia">Estonia</option>
                                    <option value="Eswatini">Eswatini</option>
                                    <option value="Ethiopia">Ethiopia</option>
                                    <option value="Fiji">Fiji</option>
                                    <option value="Finland">Finland</option>
                                    <option value="France">France</option>
                                    <option value="Gabon">Gabon</option>
                                    <option value="Gambia">Gambia</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Ghana">Ghana</option>
                                    <option value="Greece">Greece</option>
                                    <option value="Grenada">Grenada</option>
                                    <option value="Guatemala">Guatemala</option>
                                    <option value="Guinea">Guinea</option>
                                    <option value="Guinea-Bissau">Guinea-Bissau</option>
                                    <option value="Guyana">Guyana</option>
                                    <option value="Haiti">Haiti</option>
                                    <option value="Honduras">Honduras</option>
                                    <option value="Hungary">Hungary</option>
                                    <option value="Iceland">Iceland</option>
                                    <option value="India">India</option>
                                    <option value="Indonesia">Indonesia</option>
                                    <option value="Iran">Iran</option>
                                    <option value="Iraq">Iraq</option>
                                    <option value="Ireland">Ireland</option>
                                    <option value="Israel">Israel</option>
                                    <option value="Italy">Italy</option>
                                    <option value="Jamaica">Jamaica</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Vietnam">Phạm Nhy</option>
                                    <option value="Jordan">Jordan</option>
                                    <option value="Kazakhstan">Kazakhstan</option>
                                    <option value="Kenya">Kenya</option>
                                    <option value="Kiribati">Kiribati</option>
                                    <option value="Kuwait">Kuwait</option>
                                    <option value="Kyrgyzstan">Kyrgyzstan</option>
                                    <option value="Laos">Laos</option>
                                    <option value="Latvia">Latvia</option>
                                    <option value="Lebanon">Lebanon</option>
                                    <option value="Lesotho">Lesotho</option>
                                    <option value="Liberia">Liberia</option>
                                    <option value="Libya">Libya</option>
                                    <option value="Liechtenstein">Liechtenstein</option>
                                    <option value="Lithuania">Lithuania</option>
                                    <option value="Luxembourg">Luxembourg</option>
                                    <option value="Madagascar">Madagascar</option>
                                    <option value="Malawi">Malawi</option>
                                    <option value="Malaysia">Malaysia</option>
                                    <option value="Maldives">Maldives</option>
                                    <option value="Mali">Mali</option>
                                    <option value="Malta">Malta</option>
                                    <option value="Marshall Islands">Marshall Islands</option>
                                    <option value="Mauritania">Mauritania</option>
                                    <option value="Mauritius">Mauritius</option>
                                    <option value="Mexico">Mexico</option>
                                    <option value="Micronesia">Micronesia</option>
                                    <option value="Moldova">Moldova</option>
                                    <option value="Monaco">Monaco</option>
                                    <option value="Mongolia">Mongolia</option>
                                    <option value="Montenegro">Montenegro</option>
                                    <option value="Morocco">Morocco</option>
                                    <option value="Mozambique">Mozambique</option>
                                    <option value="Myanmar">Myanmar</option>
                                    <option value="Namibia">Namibia</option>
                                    <option value="Nauru">Nauru</option>
                                    <option value="Nepal">Nepal</option>
                                    <option value="Netherlands">Netherlands</option>
                                    <option value="New Zealand">New Zealand</option>
                                    <option value="Nicaragua">Nicaragua</option>
                                    <option value="Niger">Niger</option>
                                    <option value="Nigeria">Nigeria</option>
                                    <option value="North Korea">North Korea</option>
                                    <option value="North Macedonia">North Macedonia</option>
                                    <option value="Norway">Norway</option>
                                    <option value="Oman">Oman</option>
                                    <option value="Pakistan">Pakistan</option>
                                    <option value="Palau">Palau</option>
                                    <option value="Palestine">Palestine</option>
                                    <option value="Panama">Panama</option>
                                    <option value="Papua New Guinea">Papua New Guinea</option>
                                    <option value="Paraguay">Paraguay</option>
                                    <option value="Peru">Peru</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Poland">Poland</option>
                                    <option value="Portugal">Portugal</option>
                                    <option value="Qatar">Qatar</option>
                                    <option value="Romania">Romania</option>
                                    <option value="Russia">Russia</option>
                                    <option value="Rwanda">Rwanda</option>
                                    <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                                    <option value="Saint Lucia">Saint Lucia</option>
                                    <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
                                    <option value="Samoa">Samoa</option>
                                    <option value="San Marino">San Marino</option>
                                    <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                                    <option value="Saudi Arabia">Saudi Arabia</option>
                                    <option value="Senegal">Senegal</option>
                                    <option value="Serbia">Serbia</option>
                                    <option value="Seychelles">Seychelles</option>
                                    <option value="Sierra Leone">Sierra Leone</option>
                                    <option value="Singapore">Singapore</option>
                                    <option value="Slovakia">Slovakia</option>
                                    <option value="Slovenia">Slovenia</option>
                                    <option value="Solomon Islands">Solomon Islands</option>
                                    <option value="Somalia">Somalia</option>
                                    <option value="South Africa">South Africa</option>
                                    <option value="South Korea">South Korea</option>
                                    <option value="South Sudan">South Sudan</option>
                                    <option value="Spain">Spain</option>
                                    <option value="Sri Lanka">Sri Lanka</option>
                                    <option value="Sudan">Sudan</option>
                                    <option value="Suriname">Suriname</option>
                                    <option value="Sweden">Sweden</option>
                                    <option value="Switzerland">Switzerland</option>
                                    <option value="Syria">Syria</option>
                                    <option value="Taiwan">Taiwan</option>
                                    <option value="Tajikistan">Tajikistan</option>
                                    <option value="Tanzania">Tanzania</option>
                                    <option value="Thailand">Thailand</option>
                                    <option value="Timor-Leste">Timor-Leste</option>
                                    <option value="Togo">Togo</option>
                                    <option value="Tonga">Tonga</option>
                                    <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                                    <option value="Tunisia">Tunisia</option>
                                    <option value="Turkey">Turkey</option>
                                    <option value="Turkmenistan">Turkmenistan</option>
                                    <option value="Tuvalu">Tuvalu</option>
                                    <option value="Uganda">Uganda</option>
                                    <option value="Ukraine">Ukraine</option>
                                    <option value="United Arab Emirates">United Arab Emirates</option>
                                    <option value="United Kingdom">United Kingdom</option>
                                    <option value="United States">United States</option>
                                    <option value="Uruguay">Uruguay</option>
                                    <option value="Uzbekistan">Uzbekistan</option>
                                    <option value="Vanuatu">Vanuatu</option>
                                    <option value="Vatican City">Vatican City</option>
                                    <option value="Venezuela">Venezuela</option>
                                    <option value="Yemen">Yemen</option>
                                    <option value="Zambia">Zambia</option>
                                    <option value="Zimbabwe">Zimbabwe</option>
                                </select>
                            </div>
                    <div class="form-row">
                                <label for="typeCard">Ảnh làm thẻ<br>Kích thước 3x4<span style="color: red;">(*)</span></label>
                                <span class="icon-span"><i class="fa-solid fa-image"></i></span>
                                <input type="text" id="file-name-display" placeholder="Chọn hình ảnh" readonly>
                                <button type="button" id="browse-btn">Chọn</button>
                                <!-- Input file thật sự bị ẩn đi -->
                                <input type="file" id="image-input" accept="image/png, image/jpeg">
                                <!-- Input ẩn để lưu dữ liệu ảnh đã cắt -->
                                <input type="hidden" id="cropped-image-data" name="cropped_image_data">
                            </div>
                            <div class="form-row">
                                <label for="name">Tổng tiền<span style="color: red;">(*)</span></label>
                                <span id="total-price" style="font-weight: bold; color: red;">120.000đ&nbsp;</span><span id="shipping-note">(chưa bao gồm cước vẫn chuyển)</span>
                            </div>
                            <div class="form-row">
                                <label for="name">Nơi nhận thẻ<span style="color: red;">(*)</span></label>
                                <span class="radio-span"><input type="radio" name="receive" value="home" checked><div>Nhận tại nhà (có cước)</div></span>
                            <span class="radio-span"><input type="radio" name="receive" value="library"><div>Nhận tại thư viện</div></span>
                            </div>
                            <div class="form-row captcha-row">
                                <label for="captcha">Mã xác thực <span style="color: red;">(*)</span></label>
                                <div class="captcha-block">
                                    <canvas id="captcha" width="240" height="80"></canvas>
                                    <div class="captcha-input-row">
                                        <span class="icon-span"><i class="fa-solid fa-barcode"></i></span>
                                        <input type="text" id="maXacThuc" placeholder="Nhập mã xác thực bên trên" required>
                                    </div>
                                </div>
                            </div>
                            <div class="ghichu">
                                Với việc nhấn vào ô đăng ký bên dưới, bạn cam kết chịu trách nhiệm về những thông tin mình cung cấp. Thẻ đọc dùng để sử dụng các dịch vụ tại Thư viện Quốc gia Việt Nam.
                            </div>
                            <div id="payment-qr-section" style="display: none; text-align: center; padding: 20px;">
                                <h4 style="color: #28a745; font-weight: bold;">ĐĂNG KÝ THẺ THÀNH CÔNG!</h4>
                                <p>Vui lòng quét mã QR dưới đây để hoàn tất thanh toán lệ phí.</p>

                                <img id="qr-code-image" src="" alt="Mã QR thanh toán" style="max-width: 250px; height: auto; margin: 15px 0;">

                                <div style="text-align: left; display: inline-block;">
                                    <p><strong>Ngân hàng:</strong> <span id="qr-bank"></span></p>
                                    <p><strong>Chủ tài khoản:</strong> <span id="qr-account-name"></span></p>
                                    <p><strong>Số tài khoản:</strong> <span id="qr-account-number"></span></p>
                                    <p><strong>Số tiền:</strong> <span id="qr-amount" style="font-weight: bold; color: #8d1e1e;"></span> VND</p>
                                    <p><strong>Nội dung:</strong> <span id="qr-info" style="font-weight: bold; color: #185db2;"></span></p>
                                </div>

                            <hr style="margin: 20px 0;">
                            <button id="lookup-btn" class="return-btn" style="margin-right: 10px;">Tra cứu thông tin</button>
                            <button id="new-reg-btn" class="resign-btn">Thực hiện đăng ký khác</button>
                            </div>
                            <div class="form-row form-row-btn">
                                <button type="resign" id ="resign-btn" class="resign-btn">Đăng ký</button>
                                <button type="return" class="return-btn">Nhập lại</button>
                            </div>
                        </form>
                        
                    </div>
                </div>
            </div>
            <div class="right-main">
                <div class="right-main-header">Lưu ý đăng ký thẻ thư viện</div>
                <div class="right-main-content">
                    <div class="title-content-right"><h5>(*) Bạn đọc đọc kỹ lưu ý</h5></div>
                    <div class="main-content-right">
                        <div class="note">Thẻ bạn đọc tạm thời chỉ sử dụng trực tiếp tại thư viện.</div>
                        <div class="daumuc">1. <span style="text-decoration: underline;">Đối tượng được cấp thẻ đọc</span>:</div>
                        <p>Tất cả các công dân Việt Nam và người nước ngoài đang lưu trú tại Việt Nam có CHỨNG MINH THƯ (HOẶC HỘ CHIẾU).</p>
                        <div class="daumuc">2. <span style="text-decoration: underline;">Điều kiện làm thẻ trong thư viện</span>:</div>
                        <p>Mang theo Chứng minh thư hoặc Hộ chiếu (Xin lưu lý bạn đọc không cần mang theo ảnh, ảnh sẽ được chụp trực tiếp khi đến làm thẻ)</p>
                        <div class="daumuc">3. <span style="text-decoration: underline;">Thời gian nhận lại thẻ đọc</span>:</div>
                        <p>Bạn đọc có thể nhận lại thẻ 5-10 phút sau khi khai form thông tin người làm thẻ</p>
                        <div class="daumuc">4. <span style="text-decoration: underline;">Lệ phí</span>: <em style=" font-weight: normal;">(Áp dụng cho cả việc cấp thẻ mới và đổi thẻ đã hết hạn):</em></div>
                        <p>
                            Đối với cá nhân là người Việt Nam hoặc người nước ngoài sống và làm việc tại Việt Nam: <b>120.000đ</b> <em>(Một trăm hai mươi nghìn đồng)</em>/thẻ/năm (12 tháng)
                            Đối với cán bộ hưu trí: <b>50.000đ</b> <em>(Năm mươi nghìn đồng)/thẻ/năm (12 tháng)</em>
                            Thẻ đọc dành cho Nhà nghiên cứu và Doanh nhân (thẻ vàng): <b>Loại 1 năm: 120.000đ</b> <em>(Một trăm hai mươi nghìn đồng)</em> + <b>540.000đ</b> lệ phí tham gia Câu lạc bộ Nhà nghiên cứu - Doanh Nhân [<a href="https://nlv.gov.vn/tro-giup-ban-doc/noi-quy-phong-doc-danh-cho-nha-nghien-cuu-va-doanh-nhan.html">xem thêm</a>] <br> Thẻ Thư viện Văn hóa Thiếu nhi: <b>40.000đ</b> <em>(Bốn mươi nghìn đồng)</em>/thẻ/năm (12 tháng) [<a href="https://nlv.gov.vn/tro-giup-ban-doc/thu-tuc-lam-the-thu-vien-van-hoa-thieu-nhi.htmls">xem thêm</a>]
                        </p>
                        <div class="daumuc">5. <span style="text-decoration: underline;">Những trường hợp được miễn lệ phí làm thẻ thư viện</span>:</div>
                        <p>Miễn phí làm thẻ với các đối tượng được hưởng  chính sách ưu đãi – hưởng thụ văn hóa, được qui định tại điều 2, quyết định số <a href="https://chinhphu.vn/default.aspx?pageid=27160&docid=12166">170/2003/QĐ-TTg</a> ngày 14/8/2003 của Thủ tướng chính phủ, Thư viện Quốc gia Việt Nam không thu phí Thẻ bạn đọc.</p>
                        <div class="daumuc">6. <span style="text-decoration: underline;">Thời gian làm việc:</span></div>
                        <p>Sáng: từ 8h00 đến 11h30 <br> Chiều: từ 13h30 đến 16h30 <br> Từ thứ 2 đến thứ 7 hàng tuần <em>(trừ các ngày nghỉ lễ quốc gia, và ngày nội dịch theo qui định TVQG)</em> <br> <a href="https://nlv.gov.vn/tro-giup-ban-doc/lich-phuc-vu.html">[Chi tiết lịch phục vụ]</a></p>
                        <div class="daumuc">7. <span style="text-decoration: underline;">Liên hệ trực tiếp bộ phận cấp thẻ</span>:</div>
                        <p>Bộ phận cấp thẻ TVQG <br>Địa chỉ: Số 31 Tràng Thi - Hoàn Kiếm - Hà Nội <br>Số điện thoại: 024-38254938</p>
                        <div class="notice">Nếu "Đơn đăng ký" không đúng các quy định trên, hệ thống sẽ tự động hủy đơn.</div>
                        <p style="text-align: center;" class="img-the">
                            <img style="max-width: 90%; height: auto; border-radius: 10px;" src="https://opac.nlv.gov.vn:8055/images/thethuvien.jpg" alt="Hình ảnh thẻ bạn đọc"><br>
                            <i>Hình ảnh thẻ bạn đọc</i>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="cropper-modal">
        <div class="modal-content">
            <div id="image-to-crop-container"><img id="image-to-crop" src=""></div>
            <div class="modal-controls">
                <button id="zoom-in-btn" title="Phóng to">➕</button><button id="zoom-out-btn" title="Thu nhỏ">➖</button>
                <button id="rotate-left-btn" title="Xoay trái">↺</button><button id="rotate-right-btn" title="Xoay phải">↻</button>
                <button id="cancel-button">Hủy</button><button id="crop-button">✅ Hoàn thành</button>
            </div>
        </div>
    </div> 

<script>
$(document).ready(function() {

    let currentCatchaCode = '';

    // =================================================================
    // KHỐI 1: CÁC HÀM TIỆN ÍCH VÀ VALIDATION
    // =================================================================

    function updateValidationState(element, isValid) {
        const iconSpan = $(element).prev('.icon-span, .icon-span-select');
        if (isValid) {
            $(element).removeClass('invalid').addClass('valid');
            iconSpan.removeClass('invalid').addClass('valid');
        } else {
            $(element).removeClass('valid').addClass('invalid');
            iconSpan.removeClass('valid').addClass('invalid');
        }
    }

    const validators = {
        required: value => value.trim() !== '',
        cccd: value => /(^\d{9}$)|(^\d{12}$)/.test(value.trim()),
        email: value => /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(value.trim()),
        phone: value => /^0\d{9}$/.test(value.trim()),
        date: value => /^\d{2}\/\d{2}\/\d{4}$/.test(value.trim()),
        captcha: value => value.toUpperCase() === currentCatchaCode.toUpperCase()
    };

    const fieldsToValidate = {
        '#name': [validators.required], '#calendar': [validators.required, validators.date], '#CMND': [validators.required, validators.cccd],
        '#address': [validators.required], '#email': [validators.required, validators.email], '#phone': [validators.required, validators.phone],
        '#working': [validators.required], '#maXacThuc': [validators.required, validators.captcha]
    };

    function validateForm() {
        let isFormValid = true;
        for (const fieldId in fieldsToValidate) {
            if ($(fieldId).is(':visible')) {
                const element = $(fieldId)[0];
                const value = $(element).val();
                const rules = fieldsToValidate[fieldId];
                const isAllValid = rules.every(validator => validator(value));
                updateValidationState(element, isAllValid);
                if (!isAllValid) isFormValid = false;
            }
        }
        ['#loaiThe', '#banDoc', '#ngheNghiep'].forEach(function(fieldId) {
             if (!$(fieldId).val() || $(fieldId).val() === "") {
                 updateValidationState($(fieldId)[0], false);
                 isFormValid = false;
             }
        });
        const croppedImageData = $('#cropped-image-data').val();
        const fileNameDisplayElement = $('#file-name-display')[0]; // Lấy phần tử DOM

        if (!croppedImageData) {
            // Nếu không có dữ liệu ảnh đã cắt, báo lỗi
            updateValidationState(fileNameDisplayElement, false);
            isFormValid = false;
        } else {
            // Nếu có, đánh dấu là hợp lệ
            updateValidationState(fileNameDisplayElement, true);
        }
        return isFormValid;
    }

    function updateLoaiTheDisplayLogic() {
        const selectedOption = $('#loaiThe').find('option:selected');
        const selectedId = selectedOption.val();
        const price = selectedOption.data('price');
        if (selectedId) {
            const cmndRow = $('#cmnd-row');
            const workingRow = $('#working-row');
            if (selectedId === 'treem') {
                cmndRow.hide(); workingRow.hide(); $('#CMND, #working').val('');
                $('#total-price').text('Miễn phí'); $('#shipping-note').hide();
            } else {
                cmndRow.show(); workingRow.show();
                if (price !== undefined) { 
                    $('#total-price').text(price + 'đ '); 
                    $('#shipping-note').show(); 
                }
            }
        }
    }

    function resetForm() {
        $('#name, #calendar, #CMND, #address, #email, #phone, #working, #maXacThuc').val('');
        $('#loaiThe, #banDoc, #ngheNghiep').prop('selectedIndex', 0);
        $('#quocTich').val('Vietnam');
        $('input[name="gender"][value="Nam"]').prop('checked', true);
        $('input[name="receive"][value="home"]').prop('checked', true);
        $('#file-name-display, #image-input, #cropped-image-data').val('');
        const allFields = $('#name, #calendar, #CMND, #address, #email, #phone, #working, #loaiThe, #banDoc, #ngheNghiep, #quocTich, #maXacThuc, #file-name-display');
        allFields.removeClass('valid invalid');
        $('.icon-span, .icon-span-select').removeClass('valid invalid');
        generateCaptcha();
        updateLoaiTheDisplayLogic();
    }

    function generateCaptcha() {
        const canvas = document.getElementById("captcha");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";
        let captchaCode = "";
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";
        for (let i = 0; i < 4; i++) {
            let char = chars.charAt(Math.floor(Math.random() * chars.length));
            captchaCode += char;
            let fontSize = Math.floor(Math.random() * 10) + 28;
            ctx.font = `bold ${fontSize}px 'Inter', sans-serif`;
            ctx.fillStyle = `rgb(${Math.floor(Math.random()*150)},${Math.floor(Math.random()*150)},${Math.floor(Math.random()*150)})`;
            let x = 35 + i * 50;
            let y = canvas.height / 2 + (Math.random() * 20 - 10);
            let angle = (Math.random() * 30 - 15) * (Math.PI / 180);
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            ctx.fillText(char, 0, 0);
            ctx.restore();
        }
        currentCatchaCode = captchaCode;
        // --- THÊM NHIỄU (ĐƯỜNG THẲNG NGẪU NHIÊN) ---
            for (let i = 0; i < 5; i++) {
                ctx.strokeStyle = "#ccc";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height
                );
                ctx.lineTo(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height
                );
                ctx.stroke();
            }
        // --- THÊM NHIỄU (ĐIỂM NGẪU NHIÊN) ---
            for (let i = 0; i < 30; i++) {
                ctx.fillStyle = `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.3)`;
                ctx.beginPath();
                ctx.arc(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height,
                    1, // Bán kính của điểm
                    0,
                    2 * Math.PI
                );
                ctx.fill();
            }
    }

    // =================================================================
    // KHỐI 2: CÁC HÀM API VÀ XỬ LÝ CHÍNH
    // =================================================================
    function HandleSave() {
    if (!validateForm()) {
        generateCaptcha();
        alert("Vui lòng kiểm tra lại các thông tin đã nhập. Các ô màu đỏ là thông tin bắt buộc hoặc không đúng định dạng.");
        return;
    }

    // --- TÍNH TOÁN NGÀY THÁNG TRƯỚC KHI GỬI ĐI ---
    const registrationDate = new Date(); // Lấy ngày giờ hiện tại 1 lần duy nhất
    const expiryDate = new Date(registrationDate);
    expiryDate.setFullYear(expiryDate.getFullYear() + 1); // Cộng thêm 1 năm

    const dateObject = new Date($('#calendar').val().split('/').reverse().join('-'));
        let dataToSend = {
            "id": "",
            "cardType": $("#loaiThe").val(),
            "readerType": $("#banDoc").val(),
            "fullName": $("#name").val(),
            "dob": dateObject.toISOString(),
            "cccd": $("#CMND").val(),
            "address": $("#address").val(),
            "email": $("#email").val(),
            "tel": $("#phone").val(),
            "job": $("#ngheNghiep").val(),
            "office": $("#working").val(),
            "gender": $('input[name="gender"]:checked').val(),
            "receiveType": $('input[name="receive"]:checked').val(),

            // --- SỬA LẠI CÁC GIÁ TRỊ MẶC ĐỊNH BỊ TRỐNG ---
            "registerType": "Online",     // Thêm giá trị mặc định
            "photo": "path/to/default.jpg", // Cung cấp đường dẫn tạm hoặc để trống nếu backend cho phép null
            "status": "pending",          // Trạng thái chờ xử lý
            "cardNo": "pending",
            "representative": "",
            "createdDate": registrationDate.toISOString(),
            "createdBy": "user",            // Người tạo là "user"
            "deadline": new Date().toISOString(),
            "note": "",
            "expiredDate": expiryDate.toISOString(),
            "printCount": 0,
            "isPayment": false,
            "sentEmail": 0,
            "level": 0,
            "paymentType": "qr",          // Phương thức thanh toán là "qr"
            "nation": $('#quocTich').val(),
            "registrationCode": ""
        };
        PostRegisterCard(dataToSend);
    }

    function PostRegisterCard(dataToSend) {
        $.ajax({
            url: "http://localhost:5070/api/Register/register-card",
            type: "POST", contentType: "application/json; charset=utf-8", data: JSON.stringify(dataToSend), dataType: "json",
            success: function(response) {
                const registrationId = response.newId;
                    const croppedImageData = $('#cropped-image-data').val(); // Lấy dữ liệu ảnh đã cắt

                    // --- BỔ SUNG THÔNG TIN CHO THẺ ---
                    const issueDate = new Date(dataToSend.createdDate);
                    const expiryDate = new Date(issueDate);
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1); // Cộng thêm 1 năm (12 tháng)

                    const registrationResult = {
                        id: registrationId,
                        registrationCode: registrationId.substring(0, 8).toUpperCase(),
                        fullName: dataToSend.fullName,
                        dob: dataToSend.dob,
                        photoData: croppedImageData,
                        status: "Hoàn thành cấp thẻ (nếu bạn chưa nhận được, vui lòng đợi chúng tôi gửi thẻ cho bạn)",
                        // Dữ liệu mới được thêm vào
                        institution: dataToSend.office, // Lấy từ ô "Nơi làm việc"
                        createdDate: issueDate.toISOString(), // Ngày cấp là ngày đăng ký
                        expiredDate: expiryDate.toISOString() // Ngày hết hạn
                    };
                    sessionStorage.setItem('lookupData', JSON.stringify(registrationResult));
        // --- KẾT THÚC BỔ SUNG ---
                    if (registrationId) { PostPhoto(registrationId); }
                    const BANK_BIN = "970418";
                    const ACCOUNT_NO = "2601603708";
                    const ACCOUNT_NAME = "NHAM MINH HUY";
                    const BANK_NAME = "BIDV";
                    // Lấy giá trị và đảm bảo nó là chuỗi
                    const priceString = String($('#loaiThe').find('option:selected').data('price') || "0");
                    // Bây giờ priceString.replace sẽ luôn hoạt động
                    const amount = parseInt(priceString.replace(/\D/g, ''));
                    const memo = "DKTHE " + registrationId.substring(0, 8).toUpperCase();
                    const qrImageUrl = `https://img.vietqr.io/image/${BANK_BIN}-${ACCOUNT_NO}-print.png?amount=${amount}&addInfo=${memo}`;
                    $('#qr-code-image').attr('src', qrImageUrl);
                    $('#qr-bank').text(BANK_NAME);
                    $('#qr-account-name').text(ACCOUNT_NAME);
                    $('#qr-account-number').text(ACCOUNT_NO);
                    $('#qr-amount').text(new Intl.NumberFormat('vi-VN').format(amount));
                    $('#qr-info').text(memo);
                    $('.form-row-btn').slideUp();
                    $('#payment-qr-section').slideDown();
                    // resetForm();
                    alert(response.message);
            },
            error: function(xhr) {
                const errorResponse = xhr.responseJSON;
                alert("Đã xảy ra lỗi: " + (errorResponse ? errorResponse.message : "Không thể gửi dữ liệu."));
            }
        });
    }

    function PostPhoto(registrationId) {
        const base64ImageData = $('#cropped-image-data').val();
        if (!base64ImageData) { return; }
        const byteCharacters = atob(base64ImageData.split(',')[1]);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'image/jpeg' });
        const formData = new FormData();
        formData.append('file', blob, 'user_photo.jpg');
        $.ajax({
            url: "http://localhost:5070/api/Photo/upload-image/" + registrationId,
            type: "POST", data: formData, processData: false, contentType: false,
            success: function (response) { console.log("Tải ảnh lên thành công: " + response.message); },
            error: function (xhr) { console.error("Lỗi khi tải ảnh lên:", xhr.responseText); }
        });
    }
    
    function GetCardType() {
        $.ajax({
            url: "http://localhost:5070/api/LoaiThe/get-card-type", type: "GET",
            success: function(response) {
                let select = $("#loaiThe");
                select.empty();
                if (Array.isArray(response)) { response.forEach(item => select.append($('<option></option>').val(item.id).text(item.title).attr('data-price', item.price))); }
                updateLoaiTheDisplayLogic();
            },
            error: function() { console.error("Không thể tải loại thẻ."); }
        });
    }

    function GetReaderType() {
        $.ajax({
            url: "http://localhost:5070/api/BanDoc/get-reader-type", type: "GET",
            success: function(response) {
                let select = $("#banDoc");
                select.empty();
                if (Array.isArray(response)) { response.forEach(item => select.append($('<option></option>').val(item.id).text(item.name))); }
            },
            error: function() { console.error("Không thể tải loại bạn đọc."); }
        });
    }

    function GetCatalog() {
        $.ajax({
            url: "http://localhost:5070/api/NgheNghiep/get-catalog", type: "GET",
            success: function(response) {
                let select = $("#ngheNghiep");
                select.empty();
                if (Array.isArray(response)) { response.forEach(item => select.append($('<option></option>').val(item.id).text(item.name))); }
            },
            error: function() { console.error("Không thể tải nghề nghiệp."); }
        });
    }
    
    // =================================================================
    // KHỐI 3: GẮN SỰ KIỆN VÀ KHỞI TẠO
    // =================================================================
    const dateInput = document.getElementById('calendar');
    dateInput.addEventListener('input', function (e) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length > 2) { value = value.substring(0, 2) + '/' + value.substring(2); }
        if (value.length > 5) { value = value.substring(0, 5) + '/' + value.substring(5); }
        e.target.value = value.substring(0, 10);
    });

    for (const fieldId in fieldsToValidate) {
        $(fieldId).on('input', function() {
            const rules = fieldsToValidate[fieldId];
            const isAllValid = rules.every(validator => validator($(this).val()));
            updateValidationState(this, isAllValid);
        });
    }

    $(document).on('change', '#loaiThe, #banDoc, #ngheNghiep, #quocTich', function() { updateValidationState(this, true); });
    $('#loaiThe').on('change', function() { updateLoaiTheDisplayLogic(); });

    $("#resign-btn").on("click", function(e) { e.preventDefault(); HandleSave(); });
    $('.return-btn').on('click', function(e) { e.preventDefault(); resetForm(); });
    $(document).on('click', '#new-reg-btn', function() {
        $('#payment-qr-section').slideUp();
        $('.form-row-btn').slideDown();
        resetForm();
    });

    $(document).on('click', '#lookup-btn', function() {
    // Chuyển hướng người dùng sang trang tra cứu
    let name = $("#name").val();
    window.location.href = `tracuu?hoten=${name}`; 
    });

    // =================================================================
    // KHỐI 4: XỬ LÝ CẮT ẢNH (CROPPING)
    // =================================================================
    const imageInput = document.getElementById('image-input');
    const modal = document.getElementById('cropper-modal');
    const imageToCrop = document.getElementById('image-to-crop');
    const cropButton = document.getElementById('crop-button');
    const cancelButton = document.getElementById('cancel-button');
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const rotateLeftBtn = document.getElementById('rotate-left-btn');
    const rotateRightBtn = document.getElementById('rotate-right-btn');
    const browseBtn = document.getElementById('browse-btn');
    const fileNameDisplay = document.getElementById('file-name-display');
    const croppedImageDataInput = document.getElementById('cropped-image-data');
    let cropper = null;
    let originalFileName = '';

    browseBtn.addEventListener('click', (e) => { e.preventDefault(); imageInput.click(); });

    imageInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files && files.length > 0) {
            originalFileName = files[0].name;
            const reader = new FileReader();
            reader.onload = (event) => {
                imageToCrop.src = event.target.result;
                modal.style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 3 / 4, viewMode: 1, dragMode: 'move', autoCropArea: 0.9,
                    responsive: true, cropBoxMovable: false, cropBoxResizable: false,
                });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    function closeModalAndReset() {
        modal.style.display = 'none';
        if (cropper) { cropper.destroy(); cropper = null; }
    }
    
    cropButton.addEventListener('click', () => {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({ width: 300, height: 400, imageSmoothingQuality: 'high' });
        croppedImageDataInput.value = canvas.toDataURL('image/jpeg');
        fileNameDisplay.value = originalFileName;
        updateValidationState(fileNameDisplay, true);
        closeModalAndReset();
        // alert('Đã cắt và lưu ảnh thành công!');
    });

    cancelButton.addEventListener('click', closeModalAndReset);
    zoomInBtn.addEventListener('click', () => cropper && cropper.zoom(0.1));
    zoomOutBtn.addEventListener('click', () => cropper && cropper.zoom(-0.1));
    rotateLeftBtn.addEventListener('click', () => cropper && cropper.rotate(-90));
    rotateRightBtn.addEventListener('click', () => cropper && cropper.rotate(90));
    
    // =================================================================
    // KHỞI TẠO BAN ĐẦU
    // =================================================================
    GetCardType();
    GetReaderType();
    GetCatalog();
    generateCaptcha();

});
</script>
    @* <script src="~/js/Dky_the.js"></script> *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

